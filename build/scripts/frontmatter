#!/usr/bin/env node

var _ = require('lodash');
var path = require('path');
var glob = require("glob")
var front = require('front-matter');
var fs = require('fs-extra');
var marked = require('marked');
// Async highlighting with pygmentize-bundled
marked.setOptions({
  highlight: function (code, lang, callback) {
    require('pygmentize-bundled-cached')({ lang: lang, format: 'html' }, code, function (err, result) {
      callback(err, result.toString());
    });
  }
});

var optimist = require('optimist')
    .usage('Precompile handlebar templates.\nUsage: $0 template...', {
    })
    .check(function(argv) {
      if (argv.version) {
        return;
      }
    });

var buffer = fs.readFileSync(optimist.argv._[0]);
var parsed = front(buffer.toString());
var meta = parsed.attributes;
var moreIdx = parsed.body.search('\<\!-- more --\>')
if (moreIdx) {
    meta.intro = parsed.body.substr(0, moreIdx);
    marked(meta.intro, function(err, content) {
        meta.intro = content;
        console.log(JSON.stringify(meta));
    });
} else {
    console.log(JSON.stringify(meta));
}

