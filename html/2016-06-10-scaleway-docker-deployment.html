<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Deploying multiple web applications with Docker on Scaleway</title>

    <!-- Bootstrap -->
    <!-- <link href="/css/bootstrap.min.css" rel="stylesheet"> -->
    <!-- <link href="/css/pygments.css" rel="stylesheet"> -->
    <link href="/css/all.css" rel="stylesheet">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container">
      <div class="row page-header">
        <div class="col-md-12">
          <!--nav>
            <ul class="nav nav-pills pull-right">
              <li role="presentation" class="active"><a href="#">Home</a></li>
              <li role="presentation"><a href="#">About</a></li>
              <li role="presentation"><a href="#">Contact</a></li>
            </ul>
          </nav-->
          <h3 class="text-muted"><a href="/">vim, git, aws and other three-letter words</a></h3>
        </div>
      </div>
      <div class="row">
          <div class="col-md-12">
              <h1>Deploying multiple web applications with Docker on Scaleway</h1>
          </div>
      </div>
      <div class="row">
          <div class="col-md-12">
              <p>The purpose of this setup is:</p>
<ul>
<li>Setup multiple web apps with different dependencies on the same server</li>
<li>Link all apps to the same MySQL server</li>
<li>Manage uploaded files for web apps in the single place (so it is easy to backup them)</li>
<li>Automatically deploy and update apps on the remote server</li>
<li>Run the same setup locally, so development environment is very close to production</li>
<li>Setup backups for MySQL databases and for uploaded files</li>
</ul>
<p>In this case I deploy to <a href="https://scaleway.com">Scaleway</a>, but same approach can be used for almost any cloud service.
<!-- more --></p>
<h2 id="cloud-server">Cloud Server</h2>
<p>First, you need the cloud server with one of operation systems, <a href="https://docs.docker.com/machine/drivers/os-base/">supported by Docker Machine</a> with SSH access.
I used Scaleway&#39;s VC1S server with Ubuntu 14.04.
You also need to install <a href="https://docs.docker.com/engine/installation/linux/ubuntulinux/">Docker Engine</a> and <a href="https://docs.docker.com/machine/install-machine/">Docker Machine</a> locally.</p>
<h2 id="docker-machine-setup-docker-remotely">Docker Machine - setup Docker remotely</h2>
<p>Next step is to setup the Docker on the server, this is done with <code>docker-machine create</code> command:</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="nv">SSH_HOST</span><span class="o">=</span>111.222.333.44
<span class="nv">SSH_USER</span><span class="o">=</span>root
<span class="nv">SSH_KEY</span><span class="o">=</span>~/.ssh/id_rsa_scaleway

docker-machine create --driver generic <span class="se">\</span>
 --generic-ip-address <span class="nv">$SSH_HOST</span> <span class="se">\</span>
 --generic-ssh-user <span class="nv">$SSH_USER</span> <span class="se">\</span>
 --generic-ssh-key <span class="nv">$SSH_KEY</span> <span class="se">\</span>
 scaleway
</pre></div>

</code></pre>
<p>Here I use the <code>generic</code> docker machine driver, there are also specific drivers for popular cloud providers - <a href="https://docs.docker.com/machine/drivers/">AWS, Digital Ocean, etc</a>.</p>
<p>Check the full setup script <a href="files/scaleway-docker/init-docker.sh">here</a>, on Scaleway I also had to create loopback devices because docker setup failed with <code>[graphdriver] prior storage driver \&quot;devicemapper\&quot; failed: loopback attach failed</code>.</p>
<p>If something goes wrong during the setup, run <code>docker-machine rm scaleway</code>, fix the problem and run the setup again.</p>
<h2 id="deployment-setup">Deployment setup</h2>
<p>This project is responsible for deployment of the web applications to the remote host.</p>
<h3 id="projects-layout">Projects layout</h3>
<p>There are several web applications which I want do deploy, each packaged into the docker container.</p>
<p>On the filesystem they reside in the same <code>~/web</code> folder along with the <code>web-deploy</code> project which acts as a glue and setups everything together along with MySQL container (used by all projects) and HAProxy (listens to the port 80 and forwards requests to individual containers):</p>
<pre><code class="lang-bash"><div class="highlight"><pre>in ~/web <span class="err">$</span>
projectA/
   Dockerfile
   config/
   db/
   www/
projectB/
   Dockerfile
   config/
   db/
   www/
projectC/
   Dockerfile
   app/
   config/
   db/
   ...
web-deploy/
</pre></div>

</code></pre>
<p>The typical Dockerfile for the php application looks like this:</p>
<pre><code><div class="highlight"><pre><span class="nx">FROM</span> <span class="nx">php</span><span class="o">:</span><span class="mf">5.6</span><span class="o">-</span><span class="nx">apache</span>

<span class="nx">RUN</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">update</span> <span class="o">&amp;&amp;</span> <span class="o">\</span>
  <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">msmtp</span> <span class="nx">wget</span> <span class="o">&amp;&amp;</span> <span class="o">\</span>
  <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">clean</span>

<span class="nx">RUN</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">update</span> <span class="o">&amp;&amp;</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">y</span> <span class="o">\</span>
        <span class="nx">libfreetype6</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
        <span class="nx">libjpeg62</span><span class="o">-</span><span class="nx">turbo</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
        <span class="nx">libmcrypt</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
        <span class="nx">libpng12</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
    <span class="o">&amp;&amp;</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">php</span><span class="o">-</span><span class="nx">ext</span><span class="o">-</span><span class="nx">install</span> <span class="o">-</span><span class="nx">j$</span><span class="p">(</span><span class="nx">nproc</span><span class="p">)</span> <span class="nx">iconv</span> <span class="nx">mcrypt</span> <span class="o">\</span>
    <span class="o">&amp;&amp;</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">php</span><span class="o">-</span><span class="nx">ext</span><span class="o">-</span><span class="nx">configure</span> <span class="nx">gd</span> <span class="o">--</span><span class="kd">with</span><span class="o">-</span><span class="nx">freetype</span><span class="o">-</span><span class="nx">dir</span><span class="o">=</span><span class="err">/usr/include/ --with-jpeg-dir=/usr/include/ \</span>
    <span class="o">&amp;&amp;</span> <span class="nx">docker</span><span class="o">-</span><span class="nx">php</span><span class="o">-</span><span class="nx">ext</span><span class="o">-</span><span class="nx">install</span> <span class="o">-</span><span class="nx">j$</span><span class="p">(</span><span class="nx">nproc</span><span class="p">)</span> <span class="nx">gd</span> <span class="nx">pdo</span> <span class="nx">pdo_mysql</span> <span class="nx">mysql</span> <span class="nx">mysqli</span>

<span class="nx">COPY</span> <span class="nx">config</span><span class="o">/</span><span class="nx">msmtprc</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">msmtprc</span>

<span class="nx">RUN</span> <span class="nx">echo</span> <span class="s1">&#39;sendmail_path = &quot;/usr/bin/msmtp -t -i&quot;&#39;</span> <span class="o">&gt;</span> <span class="err">/usr/local/etc/php/conf.d/mail.ini</span>
<span class="nx">RUN</span> <span class="nx">a2enmod</span> <span class="nx">expires</span> <span class="o">&amp;&amp;</span> <span class="nx">a2enmod</span> <span class="nx">rewrite</span>

<span class="nx">COPY</span> <span class="nx">www</span><span class="o">/</span> <span class="err">/var/www/html/</span>

<span class="nx">VOLUME</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/html/files</span>
</pre></div>

</code></pre><p>This container is based on the official <a href="https://hub.docker.com/\_/php/">php image</a>.
To make the php <code>mail</code> function work, I also setup <code>msmtp</code> and configure php to use it.
The example of the msmtp configuration file is <a href="files/scaleway-docker/msmtprc">here</a>.</p>
<p>Here is also an example of the ruby-on-rails application (Redmine) Dockerfile:</p>
<pre><code><div class="highlight"><pre><span class="err">#</span> <span class="nx">re</span><span class="o">-</span><span class="nx">use</span> <span class="nx">image</span> <span class="nx">which</span> <span class="nx">we</span> <span class="nx">already</span> <span class="nx">use</span>
<span class="nx">FROM</span> <span class="nx">php</span><span class="o">:</span><span class="mf">5.6</span><span class="o">-</span><span class="nx">apache</span>
<span class="nx">MAINTAINER</span> <span class="nx">serebrov</span><span class="err">@</span><span class="nx">gmail</span><span class="p">.</span><span class="nx">com</span>

<span class="nx">RUN</span> <span class="nx">DEBIAN_FRONTEND</span><span class="o">=</span><span class="nx">noninteractive</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">update</span> <span class="o">\</span>
    <span class="o">&amp;&amp;</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="o">-</span><span class="nx">y</span> <span class="nx">ruby</span> <span class="nx">libruby</span> <span class="o">\</span>
    <span class="nx">libapache2</span><span class="o">-</span><span class="nx">mod</span><span class="o">-</span><span class="nx">passenger</span> <span class="nx">ruby</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
    <span class="nx">libmysqlclient</span><span class="o">-</span><span class="nx">dev</span> <span class="nx">libmagickcore</span><span class="o">-</span><span class="nx">dev</span> <span class="nx">libmagickwand</span><span class="o">-</span><span class="nx">dev</span> <span class="o">\</span>
    <span class="nx">build</span><span class="o">-</span><span class="nx">essential</span> <span class="o">\</span>
    <span class="nx">apache2</span> <span class="nx">ruby</span><span class="o">-</span><span class="nx">passenger</span> <span class="o">\</span>
    <span class="o">&amp;&amp;</span> <span class="nx">gem</span> <span class="nx">install</span> <span class="nx">bundler</span>

<span class="nx">WORKDIR</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/redmine/</span>
<span class="nx">COPY</span> <span class="p">.</span><span class="o">/</span> <span class="err">/var/www/redmine/</span>
<span class="nx">COPY</span> <span class="nx">config_prod</span><span class="o">/*</span><span class="p">.</span><span class="nx">yml</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/redmine/config/</span>

<span class="nx">RUN</span> <span class="nx">bundle</span> <span class="nx">install</span>

<span class="nx">COPY</span> <span class="nx">config_prod</span><span class="o">/</span><span class="nx">redmine</span><span class="p">.</span><span class="nx">conf</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">apache2</span><span class="o">/</span><span class="nx">sites</span><span class="o">-</span><span class="nx">available</span>
<span class="nx">RUN</span> <span class="nx">chown</span> <span class="o">-</span><span class="nx">R</span> <span class="nx">www</span><span class="o">-</span><span class="nx">data</span><span class="o">:</span><span class="nx">www</span><span class="o">-</span><span class="nx">data</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/redmine</span>
<span class="nx">RUN</span> <span class="nx">a2enmod</span> <span class="nx">passenger</span>
<span class="nx">RUN</span> <span class="nx">a2ensite</span> <span class="nx">redmine</span>

<span class="nx">VOLUME</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/redmine/files</span>
</pre></div>

</code></pre><p>This container is based on the same base official php container as php applications just to reuse the already downloaded layers.
Ruby application is running under apache with mod passenger.</p>
<h2 id="the-web-deploy-project">The web deploy project</h2>
<p>The <code>web-deploy</code> project is a glue to build and start the containers for all web projects, link them to mysql if necessary and setup the HAProxy to forward requests to each sub-project.</p>
<pre><code class="lang-bash"><div class="highlight"><pre>in ~/web <span class="err">$</span>
projectA/
projectB/
projectC/
   ...
web-deploy/
  deploy.sh
  init-docker.sh
  init-db-files.sh
  mysql-cli.sh
  utils.sh
  /haproxy
  /mysql
  /build
    projectA.sh
    projectB.sh
    projectC.sh
</pre></div>

</code></pre>
<p>Top level scripts include:</p>
<ul>
<li><a href="files/scaleway-docker/deploy.sh">web-deploy/deploy.sh</a> - deploy all apps locally or to the remote instance</li>
<li><a href="files/scaleway-docker/init-docker.sh">web-deploy/init-docker.sh</a> - use it for initial server setup (only needed once, for the new server)</li>
<li><a href="files/scaleway-docker/init-db-files.sh">web-deploy/init-db-files.sh</a> - uploads files and database dumps to remote server and then goes over dumps in mysql/dump and drops/creates databases and loads dumps, also users <a href="files/scaleway-docker/init-db.sh">web-deploy/mysql/init-db.sh</a> and <a href="files/scaleway-docker/load-dumps.sh">web-deploy/mysql/dumps/load-dumps.sh</a>, dump files should be under <code>web-deploy/mysql/dumps</code></li>
<li><a href="files/scaleway-docker/mysql-cli.sh">web-deploy/mysql-cli.sh</a> can be user to start the MySQL client for the MySQL container</li>
</ul>
<p>The <code>deploy.sh</code> script uses docker-machine to build and run the containers on the remote server.
There are several modes it can be used it:</p>
<ul>
<li><code>./deploy.sh</code> - deploy (or update) all projects locally</li>
<li><code>./deploy.sh local projectA</code> - deploy only projectA locally</li>
<li><code>./deploy.sh production</code> - deploy only projectA on the remote server</li>
<li><code>./deploy.sh production projectA</code> - deploy only projectA on the remote server</li>
</ul>
<p>The script looks like this:</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>
<span class="nb">set</span> -e

<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span><span class="s2">&quot;local&quot;</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$1&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">ENVIRONMENT</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">else</span>
    <span class="nb">echo </span>Environment name is not specified, using <span class="s1">&#39;local&#39;</span>.
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$2&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="c"># deploy only the specified project</span>
    <span class="c"># for example ./deploy.sh production projecta.com</span>
    <span class="c"># will run ./build/projecta.com</span>
    <span class="nv">PROJECTS</span><span class="o">=</span><span class="nv">$SCRIPT_PATH</span>/build/<span class="nv">$2</span>.sh
<span class="k">else</span>
    <span class="c"># deploy all projects</span>
    <span class="nv">PROJECTS</span><span class="o">=</span><span class="nv">$SCRIPT_PATH</span>/build/*.sh
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Deploy $PROJECTS&quot;</span>
<span class="nb">read</span> -p <span class="s2">&quot;Do you want to continue? &quot;</span> -n <span class="m">1</span> -r
<span class="nb">echo</span>    <span class="c"># (optional) move to a new line</span>
<span class="k">if</span> <span class="o">[[</span> ! <span class="nv">$REPLY</span> <span class="o">=</span>~ ^<span class="o">[</span>Yy<span class="o">]</span><span class="nv">$ </span><span class="o">]]</span>
<span class="k">then</span>
    <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c"># add mysql and haproxy, always update them</span>
<span class="nv">PROJECTS</span><span class="o">=</span><span class="s2">&quot;$SCRIPT_PATH/mysql/build.sh &quot;</span><span class="nv">$PROJECTS</span><span class="s2">&quot; $SCRIPT_PATH/haproxy/build.sh&quot;</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENVIRONMENT&quot;</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">eval</span> <span class="s2">&quot;$(docker-machine env scaleway)&quot;</span>
  docker-machine ip scaleway
  <span class="nb">set</span> +a
  <span class="nb">export</span> <span class="p">|</span> grep DOCKER
<span class="k">fi</span>

<span class="k">for</span> project in <span class="nv">$PROJECTS</span>
<span class="k">do</span>
    <span class="nb">echo</span> <span class="s1">&#39;Project: &#39;</span> <span class="nv">$project</span>
    <span class="nv">$project</span> <span class="nv">$ENVIRONMENT</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENVIRONMENT&quot;</span> <span class="o">==</span> <span class="s2">&quot;production&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nb">set</span> +a
  <span class="nb">export</span> <span class="p">|</span> grep DOCKER
<span class="k">fi</span>

docker ps
</pre></div>

</code></pre>
<p>Internally, the <code>deploy.sh</code> script goes over the scripts under <code>/build</code> sub-folder with build scripts and executes them to create or update docker containers.</p>
<p>The build script looks like this:</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>
<span class="nb">set</span> -e

<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nv">APP_NAME</span><span class="o">=</span>projectA
<span class="nv">CONTAINER_NAME</span><span class="o">=</span><span class="nv">$APP_NAME</span>-docker
<span class="nv">PORT</span><span class="o">=</span>8091
<span class="nb">source</span> <span class="nv">$SCRIPT_PATH</span>/../utils.sh
<span class="nv">SRC</span><span class="o">=</span><span class="nv">$SCRIPT_PATH</span>/../../projectA

<span class="c"># if we are running locally, the container will use sources from the host filesystem</span>
<span class="c"># (we create the volume pointing to /html)</span>
<span class="c"># for production, we will copy the sources into the container</span>
<span class="nv">ENVIRONMENT</span><span class="o">=</span><span class="s2">&quot;local&quot;</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$1&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nv">ENVIRONMENT</span><span class="o">=</span><span class="nv">$1</span>
<span class="k">fi</span>
<span class="nv">ENV_DOCKER_OPTS</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;$ENVIRONMENT&quot;</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
  <span class="nv">ENV_DOCKER_OPTS</span><span class="o">=</span><span class="s2">&quot;-v $(realpath $SRC)/html:/var/www/html&quot;</span>
<span class="k">fi</span>
<span class="nb">echo</span> <span class="s2">&quot;Environment: $ENVIRONMENT&quot;</span>

<span class="c"># go to the source folder, where Dockerfile is</span>
<span class="nb">cd</span> <span class="nv">$SRC</span>
<span class="c"># remove the image if it already exists</span>
docker_rm_app_image <span class="nv">$APP_NAME</span>
<span class="c"># rebuild the image</span>
docker build -t <span class="nv">$CONTAINER_NAME</span> .
<span class="c"># start the container</span>
docker run -d -p <span class="nv">$PORT</span>:80 -v /var/web/projectA/files:/var/www/html/data/upload --name <span class="nv">$APP_NAME</span> --link web-mysql:mysql --restart always <span class="nv">$ENV_DOCKER_OPTS</span> <span class="nv">$CONTAINER_NAME</span>
<span class="c"># initially files belong to the root user of the host OS</span>
<span class="c"># make them available to containter&#39;s www-data user</span>
docker <span class="nb">exec</span> <span class="nv">$APP_NAME</span> sh -c <span class="s1">&#39;chown -R www-data:www-data /var/www/html/files&#39;</span>
</pre></div>

</code></pre>
<p>Few interesting things happen here:</p>
<ul>
<li>This project will use port 8091 on the host machine (can be accessed as localhost:8091), this port also will be mentioned in the HAProxy config to redirect requests to this app based on the requested domain name</li>
<li>For local deployment the container will use source files from the host machine folder, so we can edit them directly without having to login to container, this is very convenient for local development</li>
<li>The web application files will be stored in the volume, which is available on the host machine at /var/web/projectA/files</li>
<li>The problem with permissions to the shared volume is solved by running <code>chown</code> from within the container (apache runs as www-data and after creation the files folder will belong to root user)</li>
<li>This build script is used both for local and remote deployment, the remote part is handled by Docker Machine which allows to run docker commands against the remote host (this is handled in the <code>deploy.sh</code> script)</li>
</ul>
<p>Note: the <code>docker_rm_app_image</code> function from the build script is defined in the <a href="files/scaleway-docker/utils.sh">utils.sh script</a>.</p>
<p>The <code>web-deploy</code> project also includes setup for HAProxy and MySQL containers.</p>
<h2 id="haproxy-setup">HAProxy setup</h2>
<p>This container (resides in the web-deploy/haproxy) runs HAProxy and it serves as main entry point. Requests to port 80 are reverse-proxied to other containers.
The Dockerfile is simple:</p>
<pre><code><div class="highlight"><pre><span class="nx">FROM</span> <span class="nx">haproxy</span><span class="o">:</span><span class="mf">1.5</span>
<span class="nx">COPY</span> <span class="p">.</span><span class="o">/</span><span class="nx">haproxy</span><span class="p">.</span><span class="nx">cfg</span> <span class="o">/</span><span class="nx">usr</span><span class="o">/</span><span class="nx">local</span><span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">haproxy</span><span class="o">/</span><span class="nx">haproxy</span><span class="p">.</span><span class="nx">cfg</span>
<span class="err">#</span> <span class="k">this</span> <span class="nx">is</span> <span class="nx">needed</span> <span class="nx">to</span> <span class="nx">setup</span> <span class="nx">ssl</span> <span class="k">for</span> <span class="nx">one</span> <span class="nx">of</span> <span class="nx">projects</span>
<span class="nx">COPY</span> <span class="p">.</span><span class="o">/</span><span class="nx">mycompany</span><span class="p">.</span><span class="nx">pem</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">ssl</span><span class="o">/</span><span class="nx">certs</span><span class="o">/</span>
</pre></div>

</code></pre><p>The configuration file looks like this:</p>
<pre><code><div class="highlight"><pre><span class="nx">global</span>
    <span class="nx">log</span> <span class="o">/</span><span class="nx">dev</span><span class="o">/</span><span class="nx">log</span> <span class="nx">local2</span>
    <span class="nx">maxconn</span>     <span class="mi">2048</span>
    <span class="nx">tune</span><span class="p">.</span><span class="nx">ssl</span><span class="p">.</span><span class="k">default</span><span class="o">-</span><span class="nx">dh</span><span class="o">-</span><span class="nx">param</span> <span class="mi">2048</span>
    <span class="err">#</span><span class="nx">debug</span>

<span class="nx">defaults</span>
    <span class="nx">log</span>     <span class="nx">global</span>
    <span class="nx">option</span>  <span class="nx">dontlognull</span>
    <span class="nx">mode</span> <span class="nx">http</span>
    <span class="nx">option</span> <span class="nx">forwardfor</span>
    <span class="nx">option</span> <span class="nx">http</span><span class="o">-</span><span class="nx">server</span><span class="o">-</span><span class="nx">close</span>
    <span class="nx">timeout</span> <span class="nx">connect</span> <span class="mi">5000</span><span class="nx">ms</span>
    <span class="nx">timeout</span> <span class="nx">client</span> <span class="mi">50000</span><span class="nx">ms</span>
    <span class="nx">timeout</span> <span class="nx">server</span> <span class="mi">50000</span><span class="nx">s</span>
    <span class="nx">stats</span> <span class="nx">enable</span>
    <span class="nx">stats</span> <span class="nx">auth</span> <span class="nx">haadimn</span><span class="o">:</span><span class="nx">ZyXuuXYZ</span>
    <span class="nx">stats</span> <span class="nx">uri</span> <span class="o">/</span><span class="nx">haproxyStats</span>

<span class="nx">frontend</span> <span class="nx">http</span><span class="o">-</span><span class="k">in</span>
    <span class="nx">bind</span> <span class="o">*:</span><span class="mi">80</span>

    <span class="err">#</span> <span class="nx">Define</span> <span class="nx">hosts</span> <span class="nx">based</span> <span class="nx">on</span> <span class="nx">domain</span> <span class="nx">names</span>
    <span class="nx">acl</span> <span class="nx">host_projecta</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">projecta</span><span class="p">.</span><span class="nx">com</span>
    <span class="nx">acl</span> <span class="nx">host_projecta</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">www</span><span class="p">.</span><span class="nx">projecta</span><span class="p">.</span><span class="nx">com</span>
    <span class="err">#</span> <span class="k">this</span> <span class="nx">name</span> <span class="nx">is</span> <span class="nx">used</span> <span class="k">for</span> <span class="nx">local</span> <span class="nx">testing</span>
    <span class="nx">acl</span> <span class="nx">host_projecta</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">www</span><span class="p">.</span><span class="nx">projecta</span><span class="p">.</span><span class="nx">local</span>
    <span class="nx">acl</span> <span class="nx">host_projectb</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">projectb</span><span class="p">.</span><span class="nx">com</span>
    <span class="nx">acl</span> <span class="nx">host_projectb</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">www</span><span class="p">.</span><span class="nx">projectb</span><span class="p">.</span><span class="nx">com</span>
    <span class="err">#</span> <span class="nx">handle</span> <span class="nx">sub</span><span class="o">-</span><span class="nx">domains</span> <span class="p">(</span><span class="nx">use</span> <span class="nx">hdr_end</span> <span class="nx">here</span><span class="p">,</span> <span class="nx">not</span> <span class="nx">hdr</span><span class="p">)</span>
    <span class="nx">acl</span> <span class="nx">host_projectc</span> <span class="nx">hdr_end</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">projectc</span><span class="p">.</span><span class="nx">com</span>

    <span class="err">#</span> <span class="nx">redirect</span> <span class="nx">projectd</span> <span class="nx">to</span> <span class="nx">https</span>
    <span class="nx">redirect</span> <span class="nx">scheme</span> <span class="nx">https</span> <span class="k">if</span> <span class="nx">host_projectd</span> <span class="o">!</span><span class="p">{</span> <span class="nx">ssl_fc</span> <span class="p">}</span>

    <span class="err">##</span> <span class="nx">figure</span> <span class="nx">out</span> <span class="nx">backend</span> <span class="nx">to</span> <span class="nx">use</span> <span class="nx">based</span> <span class="nx">on</span> <span class="nx">domainname</span>
    <span class="nx">use_backend</span> <span class="nx">projecta</span> <span class="k">if</span> <span class="nx">host_projecta</span>
    <span class="nx">use_backend</span> <span class="nx">projectb</span> <span class="k">if</span> <span class="nx">host_projectb</span>
    <span class="nx">use_backend</span> <span class="nx">projectc</span> <span class="k">if</span> <span class="nx">host_projectc</span>

<span class="nx">frontend</span> <span class="nx">https</span><span class="o">-</span><span class="k">in</span>
    <span class="nx">bind</span> <span class="o">*:</span><span class="mi">443</span> <span class="nx">ssl</span> <span class="nx">crt</span> <span class="o">/</span><span class="nx">etc</span><span class="o">/</span><span class="nx">ssl</span><span class="o">/</span><span class="nx">certs</span><span class="o">/</span><span class="nx">mycompany</span><span class="p">.</span><span class="nx">pem</span>

    <span class="err">#</span> <span class="nx">Define</span> <span class="nx">hosts</span> <span class="nx">based</span> <span class="nx">on</span> <span class="nx">domain</span> <span class="nx">names</span>
    <span class="nx">acl</span> <span class="nx">host_projectd</span> <span class="nx">hdr</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">projectd</span><span class="p">.</span><span class="nx">com</span>

    <span class="nx">use_backend</span> <span class="nx">projectd</span> <span class="k">if</span> <span class="nx">host_projectd</span>

<span class="nx">backend</span> <span class="nx">projecta</span>
    <span class="nx">balance</span> <span class="nx">roundrobin</span>
    <span class="nx">server</span> <span class="nx">srv_pawnshop</span><span class="o">-</span><span class="nx">soft</span><span class="o">-</span><span class="nx">ru</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">8091</span>

<span class="nx">backend</span> <span class="nx">projectb</span>
    <span class="nx">balance</span> <span class="nx">roundrobin</span>
    <span class="nx">server</span> <span class="nx">srv_pawnshop</span><span class="o">-</span><span class="nx">soft</span><span class="o">-</span><span class="nx">kz</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">8092</span>

<span class="nx">backend</span> <span class="nx">projectc</span>
    <span class="nx">balance</span> <span class="nx">roundrobin</span>
    <span class="nx">server</span> <span class="nx">srv_lombard</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">8093</span>

<span class="nx">backend</span> <span class="nx">projectd</span>
    <span class="nx">balance</span> <span class="nx">roundrobin</span>
    <span class="nx">server</span> <span class="nx">srv_redmine</span> <span class="mf">127.0</span><span class="p">.</span><span class="mf">0.1</span><span class="o">:</span><span class="mi">8100</span>
</pre></div>

</code></pre><p>The build script is:</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>

<span class="nb">export</span> <span class="p">|</span> grep DOCKER
docker-machine ip scaleway

<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nv">APP_NAME</span><span class="o">=</span>web-haproxy
<span class="nv">CONTAINER_NAME</span><span class="o">=</span>web-haproxy-docker
<span class="nb">source</span> <span class="nv">$SCRIPT_PATH</span>/../utils.sh

<span class="nb">pushd</span> <span class="nv">$SCRIPT_PATH</span>
docker_rm_app_image <span class="nv">$APP_NAME</span>
docker build -t <span class="nv">$CONTAINER_NAME</span> .
docker run -d --restart always --net<span class="o">=</span>host -p 80:80 -p 443:443 -v /dev/log:/dev/log --name <span class="nv">$APP_NAME</span> <span class="nv">$CONTAINER_NAME</span>
<span class="nb">popd</span>
</pre></div>

</code></pre>
<p>The HAProxy container is launched with <code>--net=host</code> option, so it can directly access all the ports exposed by other containers.</p>
<p>Some hints to to debug problems with HAProxy setup:</p>
<ul>
<li>Uncomment &#39;debug&#39; in the config file</li>
<li>Check &#39;docker logs web-haproxy&#39;</li>
<li>Check system log (/var/log/syslog), with the configuration above the HAProxy container will log to host&#39;s system log (see <a href="https://github.com/dockerfile/haproxy/issues/3">https://github.com/dockerfile/haproxy/issues/3</a>)</li>
</ul>
<p>The HAProxy also handles SSL (HTTPS) connections. For one of projects it redirects http to https.
See the config file and <a href="https://www.digitalocean.com/community/tutorials/how-to-implement-ssl-termination-with-haproxy-on-ubuntu-14-04">this post</a> for more information.</p>
<p>The HAProxy stats are available via http: hostname.com/haproxyStats. Login and password are in the config file.</p>
<h2 id="mysql-setup">MySql setup</h2>
<p>The MySql container (it is under web-deploy/mysql folder) also has a simple Dockerfile:</p>
<pre><code><div class="highlight"><pre><span class="nx">FROM</span> <span class="nx">mysql</span><span class="o">:</span><span class="mf">5.6</span>
<span class="nx">ENV</span> <span class="nx">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="nx">myrootpassword</span>

<span class="nx">VOLUME</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/mysql</span>
</pre></div>

</code></pre><p>The build script looks like this:</p>
<pre><code class="lang-bash"><div class="highlight"><pre><span class="c">#!/usr/bin/env bash</span>

<span class="nv">SCRIPT_PATH</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>
<span class="nv">APP_NAME</span><span class="o">=</span>web-mysql
<span class="nv">CONTAINER_NAME</span><span class="o">=</span><span class="nv">$APP_NAME</span>-docker
<span class="nb">source</span> <span class="nv">$SCRIPT_PATH</span>/../utils.sh

<span class="nb">pushd</span> <span class="nv">$SCRIPT_PATH</span>
docker_rm_app_image <span class="nv">$APP_NAME</span>
docker build -t <span class="nv">$CONTAINER_NAME</span> .

docker run -d -v /var/web/mysql-data:/var/lib/mysql --restart always --name <span class="nv">$APP_NAME</span> <span class="nv">$CONTAINER_NAME</span>
<span class="nb">popd</span>
</pre></div>

</code></pre>
<p>The data folder is mapped to the host machine to /var/web/mysql-data.
The app containers which need the database are linked to this container.</p>
<h2 id="docker-on-the-server">Docker on the server</h2>
<p>Some useful commands to view and manage Docker containers:</p>
<ul>
<li>Information about docker <code>docker info</code></li>
<li>List running containers: <code>docker ps</code></li>
<li>Information about specific container <code>docker inspect {appname}</code></li>
<li>View application logs <code>docker logs {appname}</code></li>
<li>Restart application <code>docker restart {appname}</code></li>
<li>Run shell inside the container: <code>docker exec -it {appname} bash  # replace {appname} with name from docker ps</code></li>
<li>Run the command inside the container (in this case - backup mysql databases): <code>docker exec web-mysql sh -c &#39;exec mysqldump --all-databases -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#39; | gzip -9 &gt; all-databases.sql.gz</code></li>
</ul>
<h2 id="cron-in-docker-and-backups-on-scaleway">Cron in Docker and Backups on Scaleway</h2>
<p>There are few options to run cron with docker:</p>
<ul>
<li>Run cron on the host machine (cronjobs can interact with containers via <code>docker exec ...</code>)</li>
<li>Run separate container with cron (cronjobs can interact with other containers via network or shared volumes)</li>
<li>Run multiple processes inside application containers (application and cron) usind supervisor or runit, for example, see <a href="http://phusion.github.io/baseimage-docker/">http://phusion.github.io/baseimage-docker/</a>.</li>
<li>Run multiple processes via <code>CMD</code> instruction in the Dockerfile (for example, see <a href="http://programster.blogspot.com/2014/01/docker-working-with-cronjobs.html">http://programster.blogspot.com/2014/01/docker-working-with-cronjobs.html</a>)</li>
</ul>
<p>Here I chose the first option to use host machine cron. First, the host machine is Ubuntu 14.04, so it already has cron. Second, everything runs on the same machine and I have no plans to scale out this setup, so it was the easiest option.</p>
<p>The <a href="files/scaleway-docker/init-db-files.sh">web-deploy/init-db-files.sh</a> script contains code to setup cron, here is the related part:</p>
<pre><code class="lang-bash"><div class="highlight"><pre>  docker-machine ssh scaleway apt-get install -y postfix mutt s3cmd
  docker-machine scp -r ./config/web-cron scaleway:/etc/cron.d/
  docker-machine scp -r ./config/.s3cfg scaleway:/root
</pre></div>

</code></pre>
<p>The <code>postfix</code> and <code>mutt</code> are need for cron to send local emails about jobs. You can check these mails by ssh&#39;ing to the server and running mutt.
The <code>s3cmd</code> is used to backup databases and files from the shared storage to S3.
The <code>.s3cfg</code> contains credentials for <a href="http://s3tools.org/s3cmd">s3cmd</a>, it can be generated by running <code>s3cmd --configure</code>.</p>
<p>Backups are very important, because at the moment Scaleway does not provide highly reliable hardware (no RAID disks, see <a href="https://community.scaleway.com/t/i-have-questions-about-scaleway/891/2">this thread</a>).
And to <a href="https://www.scaleway.com/docs/backup-your-data-with-snapshots/">make a snapshot</a>, you need to archive the instance (it takes few minutes), make the snapshot and launch the instance again, so there is a noticeable down-time period.
So I used cront to backup files and databases to Amazon&#39;s S3.</p>
<p>Note: Scaleway has compatible to S3 storage, called <a href="https://www.scaleway.com/features/sis/">SIS</a>, but at the moment it is not available (at least in my account).
When I try to create bucket from the command line it returns <code>S3 error: 400 (TooManyBuckets): You have attempted to create more buckets than allowed</code>.
And the note in the Scaleway UI states &quot;We&#39;re currently scaling up our SIS infrastructure to handle the load generated by all our new users. All new bucket creation are currently forbidden to preserve the service quality for current SIS users.&quot;.</p>
<p>The cron file to perform backups looks this way:</p>
<pre><code><div class="highlight"><pre><span class="err">#</span> <span class="nx">In</span> <span class="nx">the</span> <span class="k">case</span> <span class="nx">of</span> <span class="nx">problems</span><span class="p">,</span> <span class="nx">cron</span> <span class="nx">sends</span> <span class="nx">local</span> <span class="nx">email</span><span class="p">,</span> <span class="nx">can</span> <span class="nx">be</span> <span class="nx">checked</span> <span class="kd">with</span> <span class="nx">mutt</span>
<span class="err">#</span> <span class="p">(</span><span class="nx">it</span> <span class="nx">requires</span> <span class="nx">apt</span><span class="o">-</span><span class="nx">get</span> <span class="nx">install</span> <span class="nx">postfix</span> <span class="nx">mutt</span><span class="p">)</span>
<span class="err">#</span> <span class="nx">Also</span> <span class="nx">check</span> <span class="nx">cron</span> <span class="nx">messages</span> <span class="k">in</span> <span class="err">/var/log/syslog</span>
<span class="err">#</span> <span class="nx">update</span> <span class="nx">geolite</span> <span class="nx">database</span>
<span class="err">#</span> <span class="nx">Note</span><span class="o">:</span> <span class="nx">docker</span> <span class="nx">exec</span> <span class="nx">should</span> <span class="nx">not</span> <span class="nx">have</span> <span class="o">-</span><span class="nx">t</span> <span class="p">(</span><span class="nx">tty</span><span class="p">)</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">there</span> <span class="nx">is</span> <span class="nx">no</span> <span class="nx">tty</span><span class="p">,</span> <span class="o">-</span><span class="nx">i</span> <span class="nx">is</span> <span class="nx">also</span> <span class="nx">not</span> <span class="nx">needed</span>
<span class="mi">0</span> <span class="mi">1</span> <span class="o">*</span> <span class="o">*</span> <span class="nx">Sun</span> <span class="nx">root</span> <span class="nx">docker</span> <span class="nx">exec</span> <span class="nx">projecta</span> <span class="o">/</span><span class="kd">var</span><span class="err">/www/service/cron-update-geoip-db.sh</span>
<span class="err">#</span> <span class="nx">backup</span> <span class="nx">all</span> <span class="nx">databases</span> <span class="nx">to</span> <span class="nx">s3</span>
<span class="mi">0</span> <span class="mi">5</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="nx">root</span> <span class="nx">docker</span> <span class="nx">exec</span> <span class="nx">web</span><span class="o">-</span><span class="nx">mysql</span> <span class="nx">sh</span> <span class="o">-</span><span class="nx">c</span> <span class="s1">&#39;exec mysqldump --all-databases -uroot -p&quot;$MYSQL_ROOT_PASSWORD&quot;&#39;</span> <span class="o">|</span> <span class="nx">gzip</span> <span class="o">-</span><span class="mi">9</span> <span class="o">&gt;</span> <span class="nx">all</span><span class="o">-</span><span class="nx">databases</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">gz</span> <span class="o">&amp;&amp;</span> <span class="nx">s3cmd</span> <span class="nx">put</span> <span class="nx">all</span><span class="o">-</span><span class="nx">databases</span><span class="p">.</span><span class="nx">sql</span><span class="p">.</span><span class="nx">gz</span> <span class="nx">s3</span><span class="o">:</span><span class="c1">//myweb-backup/$(date +\%Y-\%m-\%d-\%H-\%M-\%S)-all-databases.sql.gz &amp;&amp; rm all-databases.sql.gz</span>
<span class="mi">0</span> <span class="mi">6</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="nx">root</span> <span class="nx">s3cmd</span> <span class="nx">sync</span> <span class="o">/</span><span class="kd">var</span><span class="sr">/web s3:/</span><span class="o">/</span><span class="nx">myweb</span><span class="o">-</span><span class="nx">backup</span><span class="o">/</span><span class="nx">storage</span><span class="o">/</span>
</pre></div>

</code></pre><p>The command to backup mysql databases does few things:</p>
<ul>
<li>Run <code>mysqldump</code> inside the MySQL container via <code>docker exec</code></li>
<li>Pipe the result to <code>gzip</code> to archive it</li>
<li>Put the archive to S3, add a timestamp to the file name</li>
</ul>
<p>And since all application containers map their files folders under host&#39;s <code>/var/web</code>, I simply sync this folder to my S3 bucket.</p>
<h2 id="conclusion">Conclusion</h2>
<p>As we can see, Docker can be successfully used not only to isolate application dependencies, but, thanks to Docker Machine, also to deploy and update applications on the remote server.
Using the approach above, it is possible also provide both ease of development (in local environment source files are mapped from the host machine and can be edited outside of the container) and avoid using private images (for production source files are copied into the container).</p>
<p>This post turned to be quite long and there is a lot of source code, both for shell scripts and configs.
I am thinking on putting the whole thing to github as a sample setup project, please let me know in comments if that would be useful.</p>
<div class="popup">
    <div class="close">close</div>
    <div class="download"><a href="">Download (<span class="name"></span>)</a></div>
    <div class="popup-content"></div>
</div>

<p><style type="text/css">
</style></p>
<script type="text/javascript">
$(document).ready(function() {
    var popup = {
      _$link: null,

      show: function($link) {
        if (this._$link) {
          this.hide();
        }
        this._$link = $link;
        this._$link.addClass("selected");
        var self = this;
        $.get(this._$link.attr('href'), function(data) {
            $(".popup-content").html(data);
            $(".popup .download a").attr('href', self._$link.attr('href'));
            $(".popup .download a span.name").html(
                self._$link.attr('href').split('/').pop()
            );
            $(".popup").slideFadeToggle(function() {
                //can do something here
            });
        });
      },

      hide: function() {
        if (!this._$link) {
          return;
        }
        var self = this;
        $('.popup').slideFadeToggle(function() {
          self._$link.removeClass('selected');
          self._$link = null;
        });
      }
    };

    $.fn.slideFadeToggle = function(easing, callback) {
      return this.animate({ opacity: 'toggle', height: 'toggle' }, 'fast', easing, callback);
    };

    $('.close').on('click', function(e) {
      popup.hide();
      e.stopPropagation();
    });
    $('body').on('click', function(e) {
      if ($(e.target).parents('.popup').length > 0) {
        return;
      }
      popup.hide();
    });

    function isSelectable(link) {
        var href = $(link).attr('href');
        if (href && href.endsWith("config")) {
            return true;
        }
        return false;
    }
    $("a").each(function(idx, link) {
        if (isSelectable(link)) {
          $(link).addClass('selectable');
        }
    });
    $("a").click(function(event) {
        var elem = $(event.target);
        if (!isSelectable(elem)) {
            return true;
        }
        if ($(this).hasClass("selected")) {
            popup.hide();
        } else {
            popup.show($(this));
        }
        return false;
    });
});
</script>

          </div>
      </div>
      <div class="row">
          <div class="col-md-12">
<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'serebrov'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          </div>
      </div>
    </div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.15/angular.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!--script src="/js/bootstrap.min.js"></script-->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-58056088-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>

