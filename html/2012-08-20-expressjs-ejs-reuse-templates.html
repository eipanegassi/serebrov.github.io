<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title></title>

    <!-- Bootstrap -->
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/pygments.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div><h1 id="express-js-and-ejs-reuse-template-on-server-and-client">express.js and ejs - reuse template on server and client</h1>
<p><a href="https://github.com/visionmedia/ejs">ejs</a> has a <a href="https://github.com/visionmedia/ejs#client-side-support">client-side support</a> but documentation and examples do not describe how to reuse the same template on the server and on the client side.</p>
<p>For now I found two ways to do it. First way is to send a request from the client, get a template from a file and render it. And the second - put a template into the page when render it on the server and then just use the template on the client.</p>
<h2 id="dynamically-get-a-template-from-the-server-and-render-it">Dynamically get a template from the server and render it</h2>
<p>To be able to load a template from a file we need to put shared templates (used both on the sever and the client) under the &quot;public&quot; folder. Assume we have &quot;public/tpl/template.ejs&quot;.</p>
<p>Render on the server (this code will be inside of a parent view which uses &#39;template.ejs&#39; as partial):</p>
<pre><code><div class="highlight"><pre><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dataItems&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;%</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataItems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
    <span class="o">&lt;%-</span> <span class="nx">partial</span><span class="p">(</span><span class="s1">&#39;../public/tpl/template&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">dataItems</span><span class="p">[</span><span class="nx">i</span><span class="p">]})</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>
</pre></div>

</code></pre><p>Render on the client (you need to include client version of ejs.js into the page):</p>
<pre><code><div class="highlight"><pre><span class="kd">function</span> <span class="nx">insertTemplate</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">getTemplate</span><span class="p">(</span><span class="s1">&#39;/tpl/template.ejs&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">renderTemplate</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">tpl</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="nx">err</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="kd">var</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ejs&#39;</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">data</span><span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">tpl</span><span class="p">).</span><span class="nx">prependTo</span><span class="p">(</span><span class="s1">&#39;div.dataItems&#39;</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="kd">function</span> <span class="nx">getTemplate</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(</span><span class="nx">file</span><span class="p">,</span> <span class="p">{</span>
        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;GET&#39;</span><span class="p">,</span>
        <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="nx">error</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">xhr</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">callback</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>

</code></pre><p>Here the &#39;getTemplate&#39; function will load a template from the file on the server and return its contents. To reduce server load it could be enhanced to cache already loaded templates.
PREPARE A TEMPLATE ON THE SERVER AND USE IT ON THE CLIENT
With this method we do not need to put the template into the public folder. Assume we have our template in <code>views/_template.ejs</code>. Before rendering the view we put this template into the variable:</p>
<pre><code><div class="highlight"><pre><span class="kd">var</span> <span class="nx">templates</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">template</span><span class="o">:</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">).</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;./views/_template.ejs&#39;</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="p">};</span>
<span class="nx">res</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="s1">&#39;myview&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="err">â€¦</span><span class="p">,</span>
    <span class="nx">templates</span><span class="o">:</span> <span class="nx">templates</span>
<span class="p">});</span>
</pre></div>

</code></pre><p>The server-side rendering will be usual use of partial. Another thing we need to do inside the view is to convert &#39;templates&#39; view variable into client-side javascript variable.</p>
<pre><code><div class="highlight"><pre><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;dataItems&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;%</span> <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">dataItems</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
    <span class="o">&lt;%-</span> <span class="nx">partial</span><span class="p">(</span><span class="s1">&#39;_template&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">dataItems</span><span class="p">[</span><span class="nx">i</span><span class="p">]})</span> <span class="o">%&gt;</span>
<span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
<span class="o">&lt;</span><span class="err">/div&gt;</span>

<span class="o">&lt;</span><span class="nx">script</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="o">&gt;</span>
    <span class="nx">jQuery</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
    <span class="c1">//save templates to variable</span>
    <span class="nb">window</span><span class="p">.</span><span class="nx">templates</span> <span class="o">=</span> <span class="o">&lt;%-</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">templates</span><span class="p">)</span><span class="o">%&gt;</span><span class="p">;</span>
    <span class="p">});</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
</pre></div>

</code></pre><p>Now to render the template on the client:</p>
<pre><code><div class="highlight"><pre><span class="kd">var</span> <span class="nx">tplData</span> <span class="o">=</span> <span class="p">{...};</span>
<span class="kd">var</span> <span class="nx">html</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ejs&#39;</span><span class="p">).</span><span class="nx">render</span><span class="p">(</span><span class="nx">templates</span><span class="p">.</span><span class="nx">template</span><span class="p">,</span> <span class="p">{</span><span class="nx">data</span><span class="o">:</span> <span class="nx">tplData</span><span class="p">});</span>
<span class="nx">$</span><span class="p">(</span><span class="nx">html</span><span class="p">).</span><span class="nx">prependTo</span><span class="p">(</span><span class="s1">&#39;div.dataItems&#39;</span><span class="p">);</span>
</pre></div>

</code></pre><h2 id="links">Links</h2>
<p><a href="https://github.com/visionmedia/ejs/issues/52">Discussion in the ejs issue tracker</a></p>
</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="/js/bootstrap.min.js"></script>
  </body>
</html>

